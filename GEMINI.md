# CLAUDE.md

## 0. Организационные принципы

- Разработка ведётся по принципу **contract-first**: сначала описывается внешний контракт (API, CLI, интерфейсы), только после этого реализуется код.
- Архитектурные решения и обоснования фиксируются в документации (`docs/architecture/`, ADR), и обновляются при каждом значимом изменении.
- Новые функции и сервисы реализуются с учётом SOLID и разбивки на независимые компоненты.
- Важные решения (выбор стека, библиотек, схемы слоёв) фиксируются отдельными ADR-файлами.
- Каждый модуль сопровождается актуальной документацией (agent_meta, docstrings), а архитектурные изменения отражаются в `overview.md` и `components/*.md`.
- Прежде чем реализовывать новые функции — согласовывайте и обновляйте архитектурные схемы и контракты.

> Такой подход позволяет поддерживать промышленный уровень качества кода, упрощает ревью, onboarding и работу AI-агентов.

## 1. Стиль кода

### 1.1 SOLID (кратко для Python)

* **S — Single‑Responsibility (SRP)**: один модуль/класс отвечает только за одну задачу.
* **O — Open‑Closed (OCP)**: расширяем через наследование или композицию, не изменяя исходный код.
* **L — Liskov Substitution (LSP)**: подклассы должны полностью сохранять публичные контракты базовых классов.
* **I — Interface Segregation (ISP)**: маленькие протоколы вместо «жирных» интерфейсов; избегаем лишних зависимостей.
* **D — Dependency Inversion (DIP)**: зависимости инъецируются через абстракции; использование DI‑контейнера допускается, но не обязательно.

Дополнительные правила:

* Строгая типизация `PEP 484`, проверки `mypy` в CI.
* Форматирование кода — `ruff + black`; сортировка импортов `isort`.
* Комментарии — добавляются для пояснения сложной или неочевидной логики. Они должны быть лаконичными и отвечать на вопрос «почему?», а не «что?».
* Максимум 400 строк на модуль; вложенность функций/классов ≤ 3 уровня.
* Тесты — пишутся **только по отдельному запросу**. Автоматическая генерация тестов не требуется. Все тесты размещаются в папке `tests/` с зеркальной структурой пакета.

## 2. Структура каждого *.py* файла

В самом начале файла добавляем строку с относительным путём к файлу, затем YAML‑блок метаданных:

```python
# src/<relative/path>.py
# --- agent_meta ---
# role: auth-service
# owner: @backend
# contract: предоставляет /login, /refresh
# last_reviewed: 2025‑07‑24
# interfaces:
#   - login(username: str, password: str) -> TokenPair
#   - refresh(token: str) -> TokenPair
# --- /agent_meta ---
```

**Правила для агентов**

1. Перед чтением тела файла прочитайте `agent_meta` и осознайте назначение модуля.
2. Для детального анализа вместо полной загрузки используйте:

   ```bash
   grep -n "def login" auth_service.py
   sed -n '40,90p' auth_service.py
   ```
3. При изменении публичных интерфейсов обновите `interfaces` и `contract`.

Дополнение:
- Всегда указывайте относительный путь к файлу первой строкой комментария (например, `# src/llm_cover_letter/service.py`) — это помогает при ревью и быстром ориентировании в кодовой базе.

## 3. Документация и «следы»

* **docs/architecture/** — источник правды об архитектуре.

  * `overview.md` — высокоуровневая схема.
  * `components/<service>.md` — детали каждого сервиса с mermaid‑диаграммами.
  * `changelog.md` — ключевые изменения, обновляются автоматически агентами. Если изменения вносятся по итогам ревью из папки `.claude/reviews`, заголовок должен ссылаться на файл ревью, например: `## YYYY-MM-DD (Fixes for review: .claude/reviews/YYYY-MM-DD_review_name.md)`.
* Для каждой задачи агент может создать файл‑«хлебную крошку» (`breadcrumbs/YYYY‑MM‑DD‑task.md`) c секциями Requirements | Plan | Changes | Decisions.

## 4. Рабочий цикл агента (Plan‑Act‑Review)

1. **plan** — составьте краткий список шагов по задаче и запросите подтверждение «OK».
2. **act** — выполните **один** шаг, обновите код (и тесты, если это явно запрошено), при необходимости скорректируйте секцию `agent_meta`.
3. **review** — проверьте корректность изменений (тесты/self‑review), при необходимости внесите доработки.

Ограничения:

* Рекомендуется не превышать 1 000 токенов на сообщение. При необходимости можно увеличить лимит, но поддерживать лаконичный и структурированный стиль.
* Структурированный вывод (JSON/YAML) предпочтителен обычному тексту.

> **Важно:** всегда можно обратиться к `CLAUDE.md` за стилем, к `agent_meta` — за назначением модуля, а к `docs/architecture/*` — за архитектурой.

## 5. Локальный запуск тестов (для этого проекта)

Для локального запуска тестов на рабочей машине владельца проекта используется преднастроенное виртуальное окружение. Активируйте его и запускайте pytest:

```bash
source "/Users/mask/Documents/ПРОЕКТЫ_2024/СОЮЗ_СНАБ_workRepo/knowledge_map_release_v2/ai-neuro/semantic_venv/bin/activate"
pytest -q
```

При необходимости заменить путь на актуальный для вашей машины.
