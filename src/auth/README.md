# Модуль: Auth

## 1. Назначение

Модуль `auth` является центром аутентификации, авторизации и управления пользователями в приложении. Он полностью инкапсулирует всю логику, связанную с идентификацией пользователя и интеграцией внешних OAuth2-провайдеров, на данный момент — HeadHunter (HH.ru).

## 2. Ключевые возможности

-   **Аутентификация пользователя**: Регистрация и вход по email и паролю.
-   **Управление сессиями**: Используются безопасные серверные сессии на основе HttpOnly cookie (`sid`).
-   **Организации и членство**: Базовая реализация для мульти-tenant сценариев, где каждый пользователь принадлежит одной или нескольким организациям.
-   **Интеграция с HH.ru OAuth2**: Полный цикл подключения HH-аккаунта пользователя, включая получение, хранение и автоматическое обновление токенов.
-   **Защита эндпоинтов**: Предоставляет middleware-зависимости (`require_user`, `require_hh_connection`) для защиты роутов в других частях приложения.

## 3. Структура модуля

-   `router.py`: Определяет все API эндпоинты, предоставляемые модулем:
    -   `/auth/signup`, `/auth/login`, `/auth/logout`: Стандартный флоу аутентификации.
    -   `/me`, `/orgs`: Управление профилем и организациями.
    -   `/auth/hh/connect`, `/auth/hh/callback`, `/auth/hh/status`, `/auth/hh/disconnect`: Полный флоу для интеграции с HH.ru.
-   `service.py` (`AuthService`): Сервисный слой с бизнес-логикой для управления пользователями и сессиями.
-   `hh_service.py` (`HHAccountService`): Сервисный слой для всей логики, связанной с HH.ru (создание аккаунта, обновление токенов и т.д.).
-   `storage.py` (`AuthStorage`): Слой доступа к данным. Управляет всеми операциями с базой данных (SQLite) для таблиц, связанных с аутентификацией.
-   `hh_middleware.py`: Содержит FastAPI-зависимости (`Depends`), которые можно использовать для защиты роутов. Например, `require_hh_connection` проверяет наличие валидного HH-аккаунта у пользователя.
-   `crypto.py`: Утилиты для хеширования и проверки паролей.
-   `models.py`: Pydantic-модели для валидации данных в API-запросах и ответах.

## 4. Схема данных (SQLite)

-   `users`: Хранит данные пользователей (email, хеш пароля).
-   `organizations`: Список организаций.
-   `memberships`: Связывает пользователей с организациями.
-   `auth_sessions`: Активные сессии пользователей (привязаны к cookie `sid`).
-   `hh_accounts`: Хранит данные и токены подключенных аккаунтов HH.ru, с обязательной привязкой к `user_id`.

## 5. Принципы работы

### Флоу аутентификации пользователя

1.  Клиент отправляет запрос на `POST /auth/signup` с email и паролем.
2.  `AuthService` создает пользователя и организацию, хеширует пароль и сохраняет все в БД.
3.  Создается сессия, и клиенту возвращается cookie `sid`.
4.  Для последующих запросов клиент передает этот cookie, который сервер использует для идентификации пользователя.

### Флоу подключения HH.ru

1.  Пользователь, будучи залогиненным, переходит по адресу `GET /auth/hh/connect`.
2.  Сервер перенаправляет его на сайт HH.ru для авторизации.
3.  После успешного входа на HH.ru, пользователя перенаправляют обратно на `GET /auth/hh/callback`.
4.  `HHAccountService` получает `authorization_code`, обменивает его на `access` и `refresh` токены.
5.  Токены и информация об аккаунте HH.ru сохраняются в таблицу `hh_accounts` с привязкой к `user_id` текущего пользователя.
6.  Теперь другие части приложения (например, `WebApp`) могут запрашивать данные с HH.ru от имени этого пользователя.

## 6. Использование в приложении

Модуль `auth` подключается к основному приложению `WebApp` как `APIRouter`. Его эндпоинты становятся доступны по префиксу `/auth`. Он также предоставляет зависимости, которые `WebApp` использует для защиты своих роутов.
