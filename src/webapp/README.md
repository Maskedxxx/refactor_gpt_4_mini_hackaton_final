# Модуль: WebApp

## 1. Назначение

`WebApp` — это основной FastAPI-сервис, который предоставляет бизнес-функционал приложения конечным пользователям через REST API. Он отвечает за оркестрацию работы LLM-фич, экспорт результатов и управление временными сессиями документов.

**Важно:** `WebApp` не занимается аутентификацией пользователей или управлением токенами. Эти задачи полностью делегированы модулю `auth`. `WebApp` является потребителем сервисов аутентификации.

## 2. Ключевые возможности

-   **Универсальный API для LLM-фич**: Предоставляет единый эндпоинт `POST /features/{feature_name}/generate` для запуска любой LLM-функции (Cover Letter, GAP Analysis и т.д.).
-   **Экспорт в PDF**: Позволяет экспортировать результаты работы любой фичи в красиво оформленный PDF-документ через эндпоинт `POST /pdf/generate`.
-   **Управление сессиями документов**: Реализует механизм сессий (`/sessions/*`) для предотвращения повторного парсинга резюме и вакансий. Клиент сначала создает сессию, загружая документы, а затем использует `session_id` для вызова фич.
-   **Доступ к данным HH.ru**: Предоставляет эндпоинт `GET /vacancies` для получения списка вакансий, используя подключенный аккаунт HH.ru пользователя.

## 3. Структура модуля

-   `app.py`: Главный файл, где создается экземпляр `FastAPI` и подключаются все роутеры, включая роутер из модуля `auth`.
-   `features.py`: Реализует универсальные роуты `/features/*`. Использует `FeatureRegistry` из `llm_features` для динамического вызова нужного генератора.
-   `pdf.py`: Реализует роут `/pdf/generate`, используя `PDFExportService` из модуля `pdf_export`.
-   `sessions.py`: Реализует роуты `/sessions/init_upload` и `/sessions/init_json` для управления сессиями.
-   `storage_docs.py`: Слой доступа к данным для документов (`resume_docs`, `vacancy_docs`) и сессий (`sessions`).

## 4. Принципы работы

### Типичный сценарий использования

1.  **Аутентификация**: Пользователь регистрируется или логинится в системе через эндпоинты модуля `auth` и получает сессионный cookie.
2.  **Создание сессии**: Пользователь отправляет `POST` запрос на `/sessions/init_upload`, прикрепив PDF-файл резюме и URL вакансии.
    -   `WebApp` (с помощью `auth`-зависимости) проверяет, что пользователь залогинен.
    -   Резюме и вакансия парсятся и сохраняются в базу данных с привязкой к `user_id`.
    -   Клиенту возвращается `session_id`.
3.  **Вызов LLM-фичи**: Клиент отправляет `POST` запрос на `/features/gap_analyzer/generate`, передав в теле `session_id`.
    -   `WebApp` загружает из БД документы, связанные с этой сессией, и передает их в соответствующий LLM-генератор.
    -   Результат генерации возвращается клиенту в формате JSON.
4.  **Экспорт в PDF**: Клиент отправляет `POST` запрос на `/pdf/generate`, передав в теле JSON-результат из предыдущего шага.
    -   `WebApp` генерирует и возвращает PDF-файл.

### Взаимодействие с модулем `Auth`

`WebApp` защищает свои эндпоинты с помощью зависимостей, предоставляемых модулем `auth`:
-   `require_user`: Проверяет наличие валидной сессии и предоставляет объект пользователя. Используется, например, в `/sessions/init_upload`, чтобы привязать сессию к пользователю.
-   `require_hh_connection`: Более строгая проверка. Убеждается не только в том, что пользователь залогинен, но и в том, что к его аккаунту подключен валидный профиль HH.ru. Используется в эндпоинте `/vacancies`.

## 5. Запуск

Модуль является основной точкой входа в приложение. Для запуска сервиса выполните:

```bash
python -m src.webapp
```
Это поднимет `uvicorn` сервер, доступный по адресу `http://localhost:8080`.
