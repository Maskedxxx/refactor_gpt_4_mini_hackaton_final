# AGENTS.md

## 0. Организационные принципы

- Разработка ведётся по принципу **contract-first**: сначала описывается внешний контракт (API, CLI, интерфейсы), только после этого реализуется код.
- Архитектурные решения и обоснования фиксируются в документации (`docs/architecture/`, ADR), и обновляются при каждом значимом изменении.
- Новые функции и сервисы реализуются с учётом SOLID и разбивки на независимые компоненты.
- Важные решения (выбор стека, библиотек, схемы слоёв) фиксируются отдельными ADR-файлами.
- Каждый модуль сопровождается актуальной документацией (agent_meta, docstrings), а архитектурные изменения отражаются в `overview.md` и `components/*.md`.
- Прежде чем реализовывать новые функции — согласовывайте и обновляйте архитектурные схемы и контракты.

> Такой подход позволяет поддерживать промышленный уровень качества кода, упрощает ревью, onboarding и работу AI-агентов.

## Boot sequence (для агентов LLM)

1. Открыть `AGENTS.md` и зафиксировать правила работы (contract-first, agent_meta, Plan‑Act‑Review).
2. Открыть `README.md` в корне — получить общий обзор и варианты запуска.
3. Открыть `docs/ONBOARDING.md` — карта репозитория, порядок чтения, быстрые команды.
4. Сформировать «тонкий индекс» путей и точек входа (entrypoints) без чтения реализаций.
5. По задаче: идти в `docs/architecture/components/<module>.md` → контракты/типы/роуты → только затем минимально необходимые реализации.
6. Предпочитать интерфейсы/контракты/тесты/README модулей (не читать реализации без явной необходимости).
7. При значимых изменениях обновлять `docs/architecture/changelog.md` (лаконично, 5–8 пунктов).

## 1. Стиль кода

### 1.1 SOLID (кратко для Python)

* **S — Single‑Responsibility (SRP)**: один модуль/класс отвечает только за одну задачу.
* **O — Open‑Closed (OCP)**: расширяем через наследование или композицию, не изменяя исходный код.
* **L — Liskov Substitution (LSP)**: подклассы должны полностью сохранять публичные контракты базовых классов.
* **I — Interface Segregation (ISP)**: маленькие протоколы вместо «жирных» интерфейсов; избегаем лишних зависимостей.
* **D — Dependency Inversion (DIP)**: зависимости инъецируются через абстракции; использование DI‑контейнера допускается, но не обязательно.

Дополнительные правила:

* Строгая типизация `PEP 484`, проверки `mypy` в CI.
* Форматирование кода — `ruff + black`; сортировка импортов `isort`.
* Комментарии — добавляются для пояснения сложной или неочевидной логики. Они должны быть лаконичными и отвечать на вопрос «почему?», а не «что?».
* Максимум 400 строк на модуль; вложенность функций/классов ≤ 3 уровня.
* Тесты — пишутся **только по отдельному запросу**. Автоматическая генерация тестов не требуется. Все тесты размещаются в папке `tests/` с зеркальной структурой пакета.

## 2. Структура каждого *.py* файла

В самом начале файла размещаем строку с относительным путём к файлу, затем блок `agent_meta`:

```python
# src/<relative/path>.py
# --- agent_meta ---
# role: auth-service
# owner: @backend
# contract: предоставляет /login, /refresh
# last_reviewed: 2025‑07‑24
# interfaces:
#   - login(username: str, password: str) -> TokenPair
#   - refresh(token: str) -> TokenPair
# --- /agent_meta ---
```

**Правила для агентов**

1. Перед чтением тела файла прочитайте `agent_meta` и осознайте назначение модуля.
2. Для детального анализа вместо полной загрузки используйте:

   ```bash
   grep -n "def login" auth_service.py
   sed -n '40,90p' auth_service.py
   ```
3. При изменении публичных интерфейсов обновите `interfaces` и `contract`.

Доп. правило оформления заголовка файла:
- Всегда добавляйте первую строку-комментарий с относительным путём к файлу (например, `# src/webapp/app.py`) перед блоком `agent_meta`. Это упрощает навигацию и ревью.

## 3. Документация и «следы»

* **docs/architecture/** — источник правды об архитектуре.

  * `overview.md` — высокоуровневая схема.
  * `components/<service>.md` — детали каждого сервиса с mermaid‑диаграммами.
  * `changelog.md` — ключевые изменения, обновляются автоматически агентами. Если изменения вносятся по итогам ревью из папки `.claude/reviews`, заголовок должен ссылаться на файл ревью, например: `## YYYY-MM-DD (Fixes for review: .claude/reviews/YYYY-MM-DD_review_name.md)`.
* Для каждой задачи агент может создать файл‑«хлебную крошку» (`breadcrumbs/YYYY‑MM‑DD‑task.md`) c секциями Requirements | Plan | Changes | Decisions.

## 4. Рабочий цикл агента (Plan‑Act‑Review)

1. **plan** — составьте краткий список шагов по задаче и запросите подтверждение «OK».
2. **act** — выполните **один** шаг, обновите код (и тесты, если это явно запрошено), при необходимости скорректируйте секцию `agent_meta`.
3. **review** — проверьте корректность изменений (тесты/self‑review), при необходимости внесите доработки.

Ограничения:

* Рекомендуется не превышать 1 000 токенов на сообщение. При необходимости можно увеличить лимит, но поддерживать лаконичный и структурированный стиль.
* Структурированный вывод (JSON/YAML) предпочтителен обычному тексту.

> **Важно:** всегда можно обратиться к `CLAUDE.md` за стилем, к `agent_meta` — за назначением модуля, а к `docs/architecture/*` — за архитектурой.

## 5. Локальный запуск тестов

Рекомендуемый кросс‑платформенный способ:

- macOS/Linux:
  ```bash
  python -m venv .venv
  source .venv/bin/activate
  pip install -r requirements.txt
  pytest -q
  ```
- Windows (PowerShell):
  ```powershell
  py -m venv .venv
  .venv\Scripts\Activate.ps1
  pip install -r requirements.txt
  pytest -q
  ```

## Базовое знакомство с проектом

Рекомендуем начать с `docs/ONBOARDING.md` (карта и порядок чтения), затем прочитать `README.md` в корне репозитория.

## 6. Онбординг

Для первого знакомства с кодом реализации репозиторием и быстрых «ручек» навигации см. `docs/ONBOARDING.md`.
